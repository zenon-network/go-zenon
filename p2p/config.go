package p2p

import (
	"crypto/ecdsa"

	"github.com/ethereum/go-ethereum/crypto"
	log "github.com/inconshreveable/log15"

	"github.com/zenon-network/go-zenon/p2p/discover"
)

const (
	DefaultNodeName = "znn-node"

	DefaultListenHost = "0.0.0.0"
	DefaultListenPort = 35995
	DefaultHTTPPort   = 35997
	DefaultWSPort     = 35998

	DefaultMinPeers        = 10
	DefaultMaxPeers        = 60
	DefaultMaxPendingPeers = 10

	DefaultNetDirName        = "network"
	DefaultNetPrivateKeyFile = "network-private-key"
)

var (
	DefaultSeeders = []string{
		"enode://0e1d704aadde5eca5e2e28c0b471de703af06c5ce36ec1f1a8a9b8ef276ecf852200975a2533dafab3d868df2ed1a335eea0fb864e457739d1bb369df2d881c7@195.154.77.36:35995",
		"enode://dc325d22fe7b9c5ee3c8a185cd4ca70889819e12ade7e24d9c5c10de586c1a0dbb6c7f35f1b9caf78c6d96acea9b04524bf86ca8a43ebed823ee5cd3ea232ac7@192.153.57.105:35995",
		"enode://4c04529911e54a0fa71c32fdafec6068527282feb4657ab82eba989a493b232fe6eb1c96c2619631b630efbe617821d2558ffc327db0e0c29fb3e7ff9c325319@78.141.207.100:35995",
		"enode://a9f36e491e3039d395a75b2d3841635dfdbbe32eea8d5fb94b029fe85b90b1de23b716f5765b43ea16eff19d08e1c414323bf20dddf5433ea9480270b969798e@210.50.114.104:35995",
		"enode://fe5350c254acdd5ee4c4dd54c430d0c8649698c00728320732d7e3404c3b12e51c05d3da941ddb580d97cf91ca219fc92e7b9947e537338440ded8f311c18b17@165.227.101.245:35995",
		"enode://8da3624a825e9cc3536c6065f06f0dd38c4703bf32299f171a1d0e69d249c887220b875e1a82a38f8ecb37971d6c6d7741889abe942a1ddef75ac9dce3aa0575@62.171.148.56:35995",
		"enode://6364aedefbb25b02d67641a2c69b2784246c6a794b82e6a903f06fb3ecad8f1636b41a1c7ff94400e4a512cf893e26ae03952052e96d306b932de30af03fceef@45.77.106.147:35995",
		"enode://a86f314c068fcb323e5237cc907eeaab85d4bdb1019ce326c2590da67929dd8ac67ac4f6b15fe29ecbbfcf024208064e60344f20bbdf5902f989ab3041df374d@66.42.61.164:35995",
		"enode://0812b9dc68542286330dc768ff87719d13733400022c556a777152dac42e664f29c23a415125c9645783384fc18de91c6ece82b54338875db66530fc1da6ceeb@158.247.209.220:35995",
		"enode://1266d51fd4f880f85a19de8a07babce3dbd521fa5d8d5c8a42bfaec9682bf55b57468dc8852ae2ed0efdcf605c8f2338a75309f8d802c7f810e0eaff2fc35f0a@51.222.87.192:35995",
		"enode://21c7548ce923cab19450b8ff4edddebe61af20d58e4ec4f217a4b7cb29f949abf36d760826ab6a8c2ed46b12c27cdaa5c01d389471c5ae70a9f87618117ca7ec@168.100.11.164:35995",
		"enode://a035a79d52dcd4152b55c9bd7fb8a29e60c85455409cabf71b6cbe57b284b362c2c9772ab17792bd018eeba83586ebb01743501e6e58af1cdd8395f13959a0ef@131.153.99.14:35995",
		"enode://e64a76f95ec98b2115ca733d74bffabe9ffa558b6edf38ae050074b8f3601e148c8ccb7802dc67bd1876ec424e91ae7323b0406245a1da248190ea6046703b8f@173.199.71.172:35995",
		"enode://9aad95e045c93db568f871daece204b5c13149f0f8bada8daa176f6038fdb8b130d906ed49d5f29b30a98de1de90a65b16a9653697c6df1e26c501e58b105ffc@195.201.184.178:35995",
		"enode://b88cdc35ab4eba9a2169300385e1026468b2c71ca9db5413cd3e71e97940142f35e1e01d000c5b7dcd85799ba813b4287cf8e790b7bb6005793188e8d3c08e87@188.166.110.246:35995",
		"enode://76a19535bed8d3d79d0b0ccfc92c8f0101efb25ff4bed928a7d3c5fb8896eb69d1e96c3ded3066ab9c08341d91c30dade34762d251397af8dbdcb106112f1c16@3.213.131.134:35995",
		"enode://fe3ed424a3453e29de426b665e9e405ee19ca7103196afc0b14836af23bbddbe14619605671c1cbaf39523e0685f2633b5912c4234dfc182ab5120a60a9ca30d@98.37.49.165:35995",
		"enode://8b3b47b8bf97a4de762ee198fa60e762a5017362dbc7925a3cf07d04327e9af9a61e62a0039b6e4471cc9026c7bbfc904f4a0d49b7dd74d6c36385f8e9952f97@198.244.189.217:35995",
		"enode://0d42a19cf0c87e03de17902b370430dff70fcd5d0cb2e14f40e8496e2dadbb9ed5d23611053ec6f47c4aa8a921d66afc61de28919dbee88a0884521460172532@213.233.110.45:35995",
		"enode://db3de09472c37eb7ce6a73e161705534719cc59e589873950d187b301ed66232a47508167a97e2ea938c64a36b15ff6465ac912f84a8f817e69da975dd927100@167.99.45.34:35995",
		"enode://142031953ebc6209604418654b3bd0c7ba61ffb588eba6ab717bc4f3234b9c05846126310afaa6ac1633b076e76cd160106f23e5200597cee2cabfb93068c709@178.18.250.224:35995",
		"enode://bd6f7f30e1c017c05f248b3fc0d8f43993204a044017a3036a6eddf089641d69b4aa2681e7610cf65a7782010965045f39afd9c8b2cf7550d88aa38dd06342af@5.22.216.115:35995",
		"enode://a4835565d418408d5b5474fd7ddb186890fee53ae826f5b35293056124436aafa019de0947ca1e5669e16e31a1d10fda58b66e3625050130f116428f45608f6d@73.27.218.24:35995",
		"enode://95794e5a3d6ca9d7698b9175402d45c10c9c81d54069c9a91f1b2c372057950a576af336791610336b302d482cd4bd12f91091883c473110d9d59ab0f820149e@45.32.189.114:35995",
		"enode://c7915c1d98ae76fc4df073c6e3985455dcfe946c4137f689a2ba99f5bd63afa48acbc89044363cba5fe6517720489eadcfe11a1335b4b41871242aefae40ef02@168.100.10.52:35995",
		"enode://a5574b2b7cd44b039cad76a9a76907e02f1eb8429bd50a85dd85656985fc8496104cd4b2e474ffcc6a09ae409e719fd3316db2532e038dab3c859caf9b0b6b53@94.237.72.230:35995",
		"enode://48b5ae8f7237d7d2a5fe37bdd6d36ba453056844fb42eb4fe015201b1dedfe3131101a2876b17d19a5900881fbdca1ed390f01e6f1979117e65fff97730bf598@140.82.52.157:35995",
		"enode://147bfa0aff6f4e543d0b954145777ce6d573d3b3e2b3e290ea6e74e3b52cf1e272ab334a788ba7c0d0b186314d0764c7d564f7564dfea528c8e9a40c359ea41b@135.125.183.82:35995",
		"enode://fa8aa3474fb7c21ad710d65e998081f66db04951208610de08b52d307dc90b4377add49996c83c791836fa82c57adefe668f93f6b22a2cb977e609881b395d29@161.35.70.164:35995",
		"enode://75d2e8a7035f1bbd77bfff72ee0dc16f1e299da5f3d77098307546dd5810a4e74b5722195ebe2f1c4e88957e09422ba0db03bca7d3ea7dd6f8693f49c62f87a1@104.248.193.56:35995",
		"enode://07786899f5f69c259b377a60b177cf37285553484f6a7ba8ae1822d8f105402fc99a6d9c0f287b295d1242ae428d6418a414f0a118650c9ae6d18de8b17c8e19@87.200.190.92:35995",
		"enode://aff54bf0f552a15ad6e74d9b0160b9e920ac1356f235cb74c5bbab62d75fba88851930c668e6908fe24c42606d1fe27cf375abf97db70c182a3831f5ed1e9884@162.221.29.53:35995",
		"enode://309b531b546056b5720c9f84602970250b15a512fbcc9be92c1f550b987fa2c05cab37b03cef01f257aab018efd62622fe692c589a60b04a498dd48e87e7d227@167.179.93.52:35995",
		"enode://6b136d769cbea09f1e3fe97a5138aec6a76386afdadf8d539866b2cb99dc14567e673a1b04e9232b35a5760e1da2f790eab1baf5b421e9c72813b66b4aded34f@144.202.60.104:35995",
		"enode://f4578f4664919f0667d86d0ad62a40b779700f93c32741f65d4ef89df4704d143e9fee1306b3e4ac300edd3cddb5084ef7eb4dcce69487329bbf70fbc62a5343@94.237.81.159:35995",
		"enode://bcf31036d64766ac9f62466840fe90f2cfcccf52ca2ce9a65fbfa1b460bb5a849037460ea8c1f1472d923f0a54b9280b74cd16c10096ee1a6d8fc300aeaa9cbf@45.61.137.203:35995",
		"enode://c2a96734b699850fa9a738981d76ae40c32caa762790333bd06acecae0a5d00ffcf9312f849571f114ee8419327f57d75fb8d5c3a58c014696355ab4df56a345@174.95.101.125:35995",
		"enode://4003fba9e3fa0dc7a2065149f9ffabf8d39723bf67c93e5a4a61f29881ed709190984fb7db381fc6cd0dee99b6840d89d78af4f345052cb5c8fc7ecce1ac3e14@85.146.181.127:35995",
		"enode://feab449b66cd8919b67f7bc2d65f8b0f6052da5d9abd47e3736c2090c2747ca1ccbead6640f0689d766c937500ca1f6309cae04ccca40006bb90d5b0ec637605@168.100.11.216:35995",
		"enode://ec9bb22c5c2b0ff195bdd11fde1fcd420f18b7c796dba55812d45a2dfa2db05de1e31b54d0b57a49a650fae3ce728728b183e88d820b101f7a294b4813d2d2de@45.32.148.36:35995",
		"enode://fcb00dff0574d41ed48204b97138bc71c257e45ce75a6d947ef7db41c3505fd13367cd0add5b953a702ed507085ac203d4b014c4d329767e62301704aea8e594@135.125.203.173:35995",
		"enode://0220d5ed0e17344023d70f8e72259fe0940e232777d88f828c5be5cf67071eae26501182fdc6a9be2ce14db7a8315456594aad5d6f88609c73ad052b8183dd23@139.99.169.68:35995",
		"enode://b7ebff282d4afefd25eadf3cef53067ab5766f06e64be7b7e37f905bfb2d416b51d9dd5c47c4a89f536db8ff06ae64d85b20472947f91fa060d60b9f32d94195@174.119.191.158:35995",
		"enode://9b04a60798b2154cc75ca679d7129b17de5638b97896d1a94a003d4df05e4996d375ce2f01e96f07e10b15f381c01483f59227f010f90d61b86562ca7095c67f@97.73.244.133:35995",
		"enode://b70e7a272a94f7c90d36cb928d602ef1cf3142216f8ba927152599cd5ced4d105efdf08b040220f934618da5c5602c842be4ccfd8e642b61c1ec31e663353e8d@206.188.197.198:35995",
		"enode://2a973d12a9db040c750890c55cb2a913387d9f245c06863175127d392b6d69c980dd04813a050214c8d1e49093691ef5c6b5b180c859ddc1b36113334853404e@199.247.11.50:35995",
		"enode://cd151a34a02d70e52f2fed71c139192788c0e744bc1c0fca37d108272fdbdd9c8b7d6c1c0415387c2bb59afb7de91c47ddee85eabc5d2c270e6983f07c79ca76@164.68.123.24:35995",
		"enode://81ce7179e4fb25d9bef53b2c981a4c2c917afe12f1d90aae765a274c47b34d9a3c0eb71ee1361c689459ee9316d2f0bd610ff29476b39354e8308017da36e6f2@51.178.138.91:35995",
		"enode://39e3663c80022fcd2316f304852cceb333a948b84468d0a3c91f4e8884ee0b58ea28e17d83de7c49e57e662678fd17649526235a25538f798ccf32c1aa04807e@192.153.57.243:35995",
		"enode://601df6a827e176a4ba16cffdbd4c7a57b0ee244149dc7db79ef9b65321aecfb2715f4e65d5c55f33ca572237128801f4772fdfad450647b4a8e6d486ed53004c@24.98.100.44:35995",
		"enode://be87ecbf6550f5b25fa4104099ff6ad3d2068338e4f37c1aaef2b7ef181a1495996a784efef9db6a86922df023b94f8359d33103374edf1246f2f68e04ad86a8@151.236.218.189:35995",
		"enode://ccc881a2b9ca77c1d5f016fd070d36b4fdedb5727e7341b83c12551da05ac26e26af849d0f86547b873f00b7d02ee5ce3f36f5c96dbaa3b5fffde52e68485d5a@168.100.10.249:35995",
		"enode://ce78ab4d5652755c18f91d8425e51a922fa97ab5a667120166d2b0a2dc4a9655972c546a5cc258128c351e565f1f8df321d6b11a490a5f328c60fde2acf01fc8@168.100.8.144:35995",
		"enode://6f251124ccf79a44a372b91bbb94d8a5d411ccf085b32f99011b765afef05e58886f6ed7125c331cd92c2224a0c20f124c00e998aca0a0d9264e8871f3b61001@210.195.32.105:35995",
		"enode://a76e2f0c9ccf9bf1c9d3f73e153ac197f786a44185c5f03789b8ba282848d73f7d3018cda21694e6e817167d26c34133efaeedbdaa272ad8139b0f1aad3f40fe@139.162.193.218:35995",
		"enode://469fb9bc960dc78014cf9dbf75dc3fc181e6f2db0578e0a7ca660f68e2133bb339fed5b24505b6cf9dfbeacc9a806bd366c3212d0247fa73dcf68926affe098b@46.59.40.154:35995",
		"enode://e0e2cf0da703148008cd2f4260a68ac505b51fc024624c854b7520eda301da7392adf27d7a5bd1336eb88b679448ce9643a115fd233d31c33b129eceaafc00b7@175.157.41.7:35995",
		"enode://73abd23c2f363cae37d77e9a7dc0bb8929bea884c9e2d13b7907b5b726fcba77a90cd5ca58ce8a414fc9ceb07e366ad153168a26e0d58063884a273282972cad@136.244.118.110:35995",
		"enode://9fbfbf4029a60ca7e29c4099f125c2ae9c3cfaff6e2ae6ef61dac2ac1f62a08170dc8d335ecebf4d1da76b79b42b5585e925bc2a085fd60ae83834c6e076fe9c@168.100.9.136:35995",
		"enode://cc46e64e1f1d834867b65dd0d2ff5ad35f32b6da190862d84023d44b5605e3eb0d136fd0e91192dcc3b8d3d7d344a336aecbccffbdb4ff372ae33d87817bea76@161.35.83.30:35995",
	}
)

type Net struct {
	// This field must be set to a valid secp256k1 private key.
	privateKey *ecdsa.PrivateKey

	// Absolute path to PrivateKeyFile.
	// (defaults to .znn/ DefaultNetPrivateKeyFile on linux).
	// If Config.DataDir changes, this reflects changes accordingly.
	PrivateKeyFile string

	// MaxPeers is the maximum number of peers that can be
	// connected. It must be greater than zero.
	MaxPeers int

	// MaxPendingPeers is the maximum number of peers that can be pending in the
	// handshake phase, counted separately for inbound and outbound connections.
	// Zero defaults to preset values.
	MaxPendingPeers int

	// Name sets the node name of this server.
	Name string

	Seeders []string

	// NodeDatabase is the path to the database containing the previously seen
	// live nodes in the network.
	NodeDatabase string

	// If ListenAddr is set to a non-nil address, the server
	// will listen for incoming connections.
	//
	// If the port is zero, the operating system will pick a port. The
	// ListenAddr field will be updated with the actual address when
	// the server is started.
	ListenAddr string
	ListenPort int
}

// PrivateKey retrieves the currently configured private key of the node, checking
// first any manually set key, falling back to the one found in the configured
// data folder. If no key can be found, a new one is generated.
func (c *Net) PrivateKey() *ecdsa.PrivateKey {
	// Use any specifically configured key.
	if c.privateKey != nil {
		return c.privateKey
	}

	// Generate ephemeral key if no PrivateKeyFile is being used
	if c.PrivateKeyFile == "" {
		key, err := crypto.GenerateKey()
		if err != nil {
			log.Crit("Failed to generate ephemeral node key", "reason", err)
		}
		return key
	}

	if key, err := crypto.LoadECDSA(c.PrivateKeyFile); err == nil {
		return key
	}

	// No persistent key found, generate and store a new one.
	key, err := crypto.GenerateKey()
	if err != nil {
		log.Crit("Failed to generate node key", "reason", err)
	}

	if err := crypto.SaveECDSA(c.PrivateKeyFile, key); err != nil {
		log.Error("Failed to persist node key", "reason", err)
	}
	return key
}
func (c *Net) Nodes() ([]*discover.Node, error) {
	var err error
	nodes := make([]*discover.Node, len(c.Seeders))
	for index, nodeAddress := range c.Seeders {
		nodes[index], err = discover.ParseNode(nodeAddress)
		if err != nil {
			return nil, err
		}
	}

	return nodes, nil
}
